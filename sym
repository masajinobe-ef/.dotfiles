#!/usr/bin/env bash

GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

LOG_FILE="$HOME/.dotfiles_stow.log"

DOTFILES_DIR="$HOME/.dotfiles"
I3_DIR="$DOTFILES_DIR/i3"

AIR_DIR="$DOTFILES_DIR/air"
AIR_CONFIG_DIR="$AIR_DIR/config"

BIN_DIR="$I3_DIR/bin"
SCRIPTS_DIR="$I3_DIR/scripts"
CONFIG_DIR="$I3_DIR/config"
HOME_DIR="$I3_DIR/home"

TARGET_BIN="$HOME/.local/bin"
TARGET_SCRIPTS="$HOME/.local/scripts"
TARGET_CONFIG="$HOME/.config"
TARGET_HOME="$HOME"

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >>"$LOG_FILE"
}

exit_with_error() {
    echo -e "${RED}Ошибка: $1${NC}"
    log_message "Ошибка: $1"
    [ -n "$2" ] && log_message "Подробности: $2"
    exit 1
}

delink_directory() {
    local dir="$1"
    local target="$2"
    if [ -d "$dir" ]; then
        echo -e "${BLUE}Удаление симлинков из $target...${NC}"
        if ! stow -D --dir="$I3_DIR" --target="$target" "$(basename "$dir")"; then
            exit_with_error "Ошибка при удалении симлинков для $dir" "$(stow -D --dir="$I3_DIR" --target="$target" "$(basename "$dir")" 2>&1)"
        fi
        log_message "Симлинки из $dir успешно удалены из $target."
    else
        exit_with_error "Директория $dir не найдена."
    fi
}

stow_directory() {
    local dir="$1"
    local target="$2"
    [ ! -d "$dir" ] && exit_with_error "Директория $dir отсутствует."

    if [ ! -d "$target" ]; then
        echo -e "${BLUE}Создаю директорию $target...${NC}"
        if ! mkdir -p "$target"; then
            exit_with_error "Не удалось создать директорию $target. Проверьте права доступа."
        fi
    else
        echo -e "${GREEN}Директория $target уже существует.${NC}"
    fi

    echo -e "${BLUE}Создание симлинков из $dir в $target...${NC}"
    if ! stow --dir="$I3_DIR" --target="$target" "$(basename "$dir")"; then
        exit_with_error "Не удалось создать симлинки из $dir в $target" "$(stow --dir="$I3_DIR" --target="$target" "$(basename "$dir")" 2>&1)"
    fi
    log_message "Симлинки из $dir успешно созданы в $target."
}

delink_mode=false
use_air=false

for arg in "$@"; do
    case $arg in
    -d)
        delink_mode=true
        ;;
    -m)
        use_air=true
        ;;
    -h)
        echo "Использование: $(basename "$0") [-d] [-m] [-h]"
        echo "  -d   Удалить существующие симлинки."
        echo "  -m   Использовать директорию AIR вместо I3."
        echo "  -h   Показать это сообщение."
        exit 0
        ;;
    *)
        exit_with_error "Неизвестный аргумент: $arg"
        ;;
    esac
done

if [ "$use_air" = true ]; then
    CONFIG_DIR="$AIR_CONFIG_DIR"
fi

if [ "$delink_mode" = true ]; then
    delink_directory "$BIN_DIR" "$TARGET_BIN"
    delink_directory "$SCRIPTS_DIR" "$TARGET_SCRIPTS"
    delink_directory "$CONFIG_DIR" "$TARGET_CONFIG"
    delink_directory "$HOME_DIR" "$TARGET_HOME"
    echo -e "${GREEN}Все симлинки успешно удалены.${NC}"
    log_message "Все симлинки успешно удалены."
else
    stow_directory "$BIN_DIR" "$TARGET_BIN"
    stow_directory "$SCRIPTS_DIR" "$TARGET_SCRIPTS"
    stow_directory "$CONFIG_DIR" "$TARGET_CONFIG"
    stow_directory "$HOME_DIR" "$TARGET_HOME"
    echo -e "${GREEN}Все директории успешно связаны симлинками.${NC}"
    log_message "Все директории успешно связаны симлинками."
fi

read -p "Нажмите Enter для выхода..."
